# Migration `20200614141551-3`

This migration has been generated by Elias Bundala at 6/14/2020, 2:15:51 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "State" AS ENUM ('PENDING', 'REVIEW', 'REJECTED', 'APPROVED', 'COMPLETED', 'ARCHIVED');

CREATE TABLE "public"."Expertise" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"name" text  NOT NULL ,"pictureId" integer  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"userId" integer   ,"weight" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Bid" (
"amount" integer  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"jobId" integer  NOT NULL ,"message" text  NOT NULL ,"state" "State" NOT NULL DEFAULT E'PENDING',"timeflame" integer  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"userId" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Job" (
"body" text  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"timeflame" integer  NOT NULL ,"title" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,"userId" integer  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."File" (
"bidId" integer   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"encoding" text  NOT NULL ,"filename" text  NOT NULL ,"id" SERIAL,"jobId" integer   ,"messageId" integer   ,"mimetype" text  NOT NULL ,"path" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Chat" (
"authorId" integer  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"published" boolean  NOT NULL DEFAULT false,"title" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Message" (
"authorId" integer  NOT NULL ,"chatId" integer   ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"isReply" boolean  NOT NULL DEFAULT false,"messageId" integer   ,"published" boolean  NOT NULL DEFAULT false,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Order" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"itemId" integer  NOT NULL ,"state" "State" NOT NULL DEFAULT E'PENDING',"tokens" integer  NOT NULL DEFAULT 0,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."TokenOrder" (
"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"id" SERIAL,"ownerId" integer  NOT NULL ,"state" "State" NOT NULL DEFAULT E'PENDING',"tokens" integer  NOT NULL DEFAULT 0,"transactionId" integer  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."Transaction" (
"amount" Decimal(65,30)  NOT NULL ,"createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,"externalTransRefId" text  NOT NULL ,"id" SERIAL,"state" "State" NOT NULL DEFAULT E'PENDING',"transRefId" text  NOT NULL ,"updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "public"."_ChatToUser" (
"A" integer  NOT NULL ,"B" integer  NOT NULL )

CREATE TABLE "public"."_ExpertiseToJob" (
"A" integer  NOT NULL ,"B" integer  NOT NULL )

ALTER TABLE "public"."User" ADD COLUMN "avatorId" integer  NOT NULL ,
ADD COLUMN "passwordHash" text  NOT NULL ,
ADD COLUMN "updatedAt" timestamp(3)  NOT NULL ,
ALTER COLUMN "role" SET DEFAULT E'USER';

ALTER TABLE "public"."Post" DROP CONSTRAINT IF EXiSTS "Post_authorId_fkey";

ALTER TABLE "public"."Profile" DROP CONSTRAINT IF EXiSTS "Profile_userId_fkey";

ALTER TABLE "public"."_CategoryToPost" DROP CONSTRAINT IF EXiSTS "_CategoryToPost_A_fkey";

ALTER TABLE "public"."_CategoryToPost" DROP CONSTRAINT IF EXiSTS "_CategoryToPost_B_fkey";

CREATE UNIQUE INDEX "File.path" ON "public"."File"("path")

CREATE UNIQUE INDEX "Order_itemId" ON "public"."Order"("itemId")

CREATE UNIQUE INDEX "TokenOrder_transactionId" ON "public"."TokenOrder"("transactionId")

CREATE UNIQUE INDEX "_ChatToUser_AB_unique" ON "public"."_ChatToUser"("A","B")

CREATE  INDEX "_ChatToUser_B_index" ON "public"."_ChatToUser"("B")

CREATE UNIQUE INDEX "_ExpertiseToJob_AB_unique" ON "public"."_ExpertiseToJob"("A","B")

CREATE  INDEX "_ExpertiseToJob_B_index" ON "public"."_ExpertiseToJob"("B")

ALTER TABLE "public"."Expertise" ADD FOREIGN KEY ("pictureId")REFERENCES "public"."File"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Expertise" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Bid" ADD FOREIGN KEY ("jobId")REFERENCES "public"."Job"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Bid" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Job" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."File" ADD FOREIGN KEY ("bidId")REFERENCES "public"."Bid"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."File" ADD FOREIGN KEY ("jobId")REFERENCES "public"."Job"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."File" ADD FOREIGN KEY ("messageId")REFERENCES "public"."Message"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Chat" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Message" ADD FOREIGN KEY ("authorId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Message" ADD FOREIGN KEY ("chatId")REFERENCES "public"."Chat"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Message" ADD FOREIGN KEY ("messageId")REFERENCES "public"."Message"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."Order" ADD FOREIGN KEY ("itemId")REFERENCES "public"."Bid"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."TokenOrder" ADD FOREIGN KEY ("ownerId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."TokenOrder" ADD FOREIGN KEY ("transactionId")REFERENCES "public"."Transaction"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_ChatToUser" ADD FOREIGN KEY ("A")REFERENCES "public"."Chat"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_ChatToUser" ADD FOREIGN KEY ("B")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_ExpertiseToJob" ADD FOREIGN KEY ("A")REFERENCES "public"."Expertise"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."_ExpertiseToJob" ADD FOREIGN KEY ("B")REFERENCES "public"."Job"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."User" ADD FOREIGN KEY ("avatorId")REFERENCES "public"."File"("id") ON DELETE CASCADE  ON UPDATE CASCADE

DROP TABLE "public"."Category";

DROP TABLE "public"."Post";

DROP TABLE "public"."Profile";

DROP TABLE "public"."_CategoryToPost";
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200614110356-2..20200614141551-3
--- datamodel.dml
+++ datamodel.dml
@@ -2,53 +2,165 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
-//datasource db {
-// provider = "sqlite"
-//  url = "***"
-//}
-
 generator client {
   provider = "prisma-client-js"
 }
 model User {
+  id           Int          @default(autoincrement()) @id
+  email        String       @unique
+  name         String
+  passwordHash String
+  avator       File         @relation(fields: [avatorId], references: [id])
+  avatorId     Int
+  role         Role         @default(USER)
+  expertise    Expertise[]
+  jobs         Job[]
+  bids         Bid[]
+  chats        Chat[]
+  createdAt    DateTime     @default(now())
+  updatedAt    DateTime     @updatedAt
+  Chat         Chat[]       @relation("chat_author")
+  Message      Message[]
+  TokenOrder   TokenOrder[]
+}
+
+model Expertise {
   id        Int      @default(autoincrement()) @id
+  name      String
+  weight    Int
+  picture   File     @relation(fields: [pictureId], references: [id])
+  pictureId Int
+  jobs      Job[]    @relation(references: [id])
+  User      User?    @relation(fields: [userId], references: [id])
+  userId    Int?
   createdAt DateTime @default(now())
-  email     String   @unique
-  name      String
-  role      Role   @default(USER)
-  posts     Post[]
-  profile   Profile?
+  updatedAt DateTime @updatedAt
 }
-model Profile {
-  id     Int    @default(autoincrement()) @id
-  bio    String
-  user   User   @relation(fields: [userId], references: [id])
-  userId Int
+model Bid {
+  id          Int      @default(autoincrement()) @id
+  amount      Int
+  timeflame   Int
+  message     String
+  attachments File[]
+  order       Order
+  state       State    @default(PENDING)
+  job         Job      @relation(fields: [jobId], references: [id])
+  jobId       Int
+  author      User     @relation(fields: [userId], references: [id])
+  userId      Int
+  createdAt   DateTime @default(now())
+  updatedAt   DateTime @updatedAt
 }
-model Post {
-  id         Int        @default(autoincrement()) @id
-  createdAt  DateTime   @default(now())
-  title      String
-  published  Boolean    @default(false)
-  categories Category[] @relation(references: [id])
-  author     User       @relation(fields: [authorId], references: [id])
-  authorId   Int
+model Job {
+  id          Int         @default(autoincrement()) @id
+  title       String
+  timeflame   Int
+  body        String
+  attachments File[]
+  expertise   Expertise[] @relation(references: [id])
+  author      User        @relation(fields: [userId], references: [id])
+  userId      Int
+  Bids        Bid[]
+  createdAt   DateTime    @default(now())
+  updatedAt   DateTime    @updatedAt
 }
-model Category {
-  id    Int    @default(autoincrement()) @id
-  name  String
-  posts Post[] @relation(references: [id])
+model File {
+  id        Int         @default(autoincrement()) @id
+  path      String      @unique
+  filename  String
+  mimetype  String
+  encoding  String
+  createdAt DateTime    @default(now())
+  updatedAt DateTime    @updatedAt
+  User      User[]
+  Expertise Expertise[]
+  Bid       Bid?        @relation(fields: [bidId], references: [id])
+  bidId     Int?
+  Job       Job?        @relation(fields: [jobId], references: [id])
+  jobId     Int?
+  Message   Message?    @relation(fields: [messageId], references: [id])
+  messageId Int?
 }
+model Chat {
+  id        Int       @default(autoincrement()) @id
+  title     String
+  published Boolean   @default(false)
+  author    User      @relation(name: "chat_author", fields: [authorId], references: [id])
+  authorId  Int
+  members   User[]
+  messages  Message[]
+  createdAt DateTime  @default(now())
+  updatedAt DateTime  @updatedAt
+}
+
+model Message {
+  id          Int       @default(autoincrement()) @id
+  published   Boolean   @default(false)
+  isReply     Boolean   @default(false)
+  author      User      @relation(fields: [authorId], references: [id])
+  authorId    Int
+  replies     Message[]
+  attachments File[]
+  createdAt   DateTime  @default(now())
+  updatedAt   DateTime  @updatedAt
+  Chat        Chat?     @relation(fields: [chatId], references: [id])
+  chatId      Int?
+  Message     Message?  @relation("MessageToMessage", fields: [messageId], references: [id])
+  messageId   Int?
+}
+
+model Order {
+  id        Int      @default(autoincrement()) @id
+  item      Bid      @relation(fields: [itemId], references: [id])
+  itemId    Int
+  tokens    Int      @default(0)
+  state     State    @default(PENDING)
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+}
+
+model TokenOrder {
+  id            Int         @default(autoincrement()) @id
+  owner         User        @relation(fields: [ownerId], references: [id])
+  ownerId       Int
+  transaction   Transaction @relation(fields: [transactionId], references: [id])
+  transactionId Int
+  tokens        Int         @default(0)
+  state         State       @default(PENDING)
+  updatedAt     DateTime    @updatedAt
+  createdAt     DateTime    @default(now())
+}
+
+model Transaction {
+  id                 Int        @default(autoincrement()) @id
+  state              State      @default(PENDING)
+  externalTransRefId String
+  transRefId         String
+  amount             Float
+  updatedAt          DateTime   @updatedAt
+  createdAt          DateTime   @default(now())
+  TokenOrder         TokenOrder
+}
+
 enum Role {
- USER
- ADMIN
-}
+  USER
+  ADMIN
+}
+
+enum State {
+  PENDING
+  REVIEW
+  REJECTED
+  APPROVED
+  COMPLETED
+  ARCHIVED
+}
```


